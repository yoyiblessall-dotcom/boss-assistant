<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NEXUS | Command Center</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
  :root {
    --bg-core: #050505;
    --bg-panel: #111111;
    --border: #333;
    --accent: #007aff; /* Apple Blue */
    --text-main: #f5f5f7;
    --text-dim: #86868b;
    --success: #34c759;
    --danger: #ff3b30;
  }

  body {
    margin: 0;
    padding: 0;
    background-color: var(--bg-core);
    color: var(--text-main);
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
    height: 100vh;
    display: flex;
    overflow: hidden;
  }

  /* ä½ˆå±€æ¶æ§‹ */
  .layout-container { display: flex; width: 100%; height: 100%; }
  
  /* å·¦å´ï¼šç·¨è¼¯å€ */
  .editor-zone {
    flex: 1;
    padding: 40px;
    overflow-y: auto;
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    max-width: 60%;
  }
  .editor-zone::-webkit-scrollbar { width: 8px; }
  .editor-zone::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }

  /* å³å´ï¼šé è¦½å€ */
  .preview-zone {
    flex: 1;
    background: #000;
    display: flex;
    align-items: center;
    justify-content: center;
    background-image: radial-gradient(#222 1px, transparent 1px);
    background-size: 20px 20px;
    position: relative;
    border-left: 1px solid var(--border);
  }

  /* æ¨™é¡Œèˆ‡ç‹€æ…‹ */
  .header-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
  }
  .system-status { font-size: 12px; color: var(--success); display: flex; align-items: center; gap: 6px; }
  .status-dot { width: 6px; height: 6px; background: var(--success); border-radius: 50%; box-shadow: 0 0 8px var(--success); }

  /* è¼¸å…¥æ¨¡çµ„ */
  .module-card {
    background: var(--bg-panel);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
  }
  .module-title {
    font-size: 13px;
    text-transform: uppercase;
    color: var(--text-dim);
    letter-spacing: 1px;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  /* æœªä¾†æ„Ÿè¼¸å…¥æ¡† */
  .input-group { margin-bottom: 15px; position: relative; }
  .input-label { font-size: 12px; color: var(--text-dim); margin-bottom: 6px; display: block; }
  .cyber-input {
    width: 100%;
    background: transparent;
    border: none;
    border-bottom: 1px solid var(--border);
    color: var(--text-main);
    padding: 10px 0;
    font-size: 15px;
    font-family: 'Courier New', monospace; /* æ•¸æ“šæ„Ÿ */
    transition: 0.3s;
    box-sizing: border-box;
  }
  .cyber-input:focus { outline: none; border-bottom-color: var(--accent); }
  .cyber-input::placeholder { color: #333; }

  /* QA åˆ—è¡¨æ¨£å¼ */
  .qa-block {
    background: rgba(255,255,255,0.03);
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    position: relative;
    border-left: 2px solid var(--accent);
    transition: 0.2s;
  }
  .qa-block:hover { background: rgba(255,255,255,0.06); }
  .qa-header { display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center; }
  .qa-textarea {
    width: 100%;
    background: rgba(0,0,0,0.3);
    border: 1px solid var(--border);
    color: var(--text-main);
    padding: 10px;
    border-radius: 6px;
    resize: vertical;
    min-height: 60px;
    font-size: 14px;
    box-sizing: border-box;
    font-family: inherit;
  }
  .qa-textarea:focus { outline: none; border-color: var(--accent); }
  
  /* æŒ‰éˆ•ç¾¤ */
  .btn-action {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-main);
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    transition: 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 5px;
  }
  .btn-action:hover { border-color: var(--text-main); background: rgba(255,255,255,0.1); }
  .btn-delete { color: var(--danger); border-color: rgba(255, 59, 48, 0.3); }
  .btn-delete:hover { background: rgba(255, 59, 48, 0.1); border-color: var(--danger); }
  
  .btn-deploy {
    background: var(--accent);
    color: white;
    border: none;
    padding: 15px 24px;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 0 20px rgba(0, 122, 255, 0.2);
    transition: 0.3s;
    width: 100%;
    margin-top: 20px;
    text-align: center;
    font-size: 14px;
    letter-spacing: 0.5px;
  }
  .btn-deploy:hover { box-shadow: 0 0 30px rgba(0, 122, 255, 0.4); transform: translateY(-1px); }
  .btn-deploy:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(100%); }

  /* æ‰‹æ©Ÿæ¨¡æ“¬å™¨ (å®Œå…¨å°æ‡‰å‰å°æ¨£å¼) */
  .phone-mockup {
    width: 350px;
    height: 700px;
    border: 12px solid #222;
    border-radius: 50px;
    background: #000;
    overflow: hidden;
    position: relative;
    box-shadow: 0 30px 80px rgba(0,0,0,0.8);
  }
  .notch {
    position: absolute; top: 0; left: 50%; transform: translateX(-50%);
    width: 120px; height: 25px; background: #222;
    border-bottom-left-radius: 16px; border-bottom-right-radius: 16px; z-index: 20;
  }
  
  /* æ¨¡æ“¬å‰å°ä»‹é¢ */
  .sim-screen { 
    height: 100%; display: flex; flex-direction: column; 
    background-image: url('https://images.unsplash.com/photo-1518770660439-4636190af475?q=80&w=2670');
    background-size: cover; background-position: center;
    color: white; font-family: sans-serif;
    position: relative;
  }
  .sim-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.4); z-index: 1; }
  .sim-content { position: relative; z-index: 2; flex: 1; display: flex; flex-direction: column; padding: 20px; padding-top: 50px;}

  .sim-top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
  .sim-title { font-weight: bold; font-size: 16px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
  .sim-capsules { display: flex; gap: 5px; }
  .sim-capsule { font-size: 10px; padding: 4px 8px; border-radius: 10px; background: rgba(255,255,255,0.2); backdrop-filter: blur(5px); display: none;}

  .sim-chat { flex: 1; display: flex; flex-direction: column; gap: 10px; overflow-y: hidden; justify-content: flex-end; padding-bottom: 60px;}
  .sim-bubble { 
    padding: 10px 14px; border-radius: 16px; font-size: 13px; line-height: 1.4; max-width: 85%;
    backdrop-filter: blur(10px); box-shadow: 0 2px 10px rgba(0,0,0,0.2);
  }
  .sim-bubble.bot { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.1); border-bottom-left-radius: 2px; align-self: flex-start; }
  
  .sim-chips { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 5px; }
  .sim-chip { 
    font-size: 11px; padding: 6px 10px; border-radius: 12px; 
    background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1);
  }

  /* Loading Overlay */
  .loading-overlay {
    position: fixed; inset: 0; background: var(--bg-core); z-index: 999;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    color: var(--accent); font-family: monospace;
  }
</style>
</head>
<body>

<!-- Loading ç•«é¢ -->
<div class="loading-overlay" id="loadingScreen">
  <i class="fas fa-satellite-dish fa-spin fa-2x"></i>
  <p style="margin-top:20px;">ESTABLISHING UPLINK...</p>
</div>

<div class="layout-container">
  
  <!-- å·¦å´ï¼šæ§åˆ¶å° -->
  <div class="editor-zone">
    <div class="header-bar">
      <div>
        <h1 style="margin:0; font-size: 24px; font-weight:700;">NEXUS CONTROL</h1>
        <span style="font-size:12px; color:var(--text-dim);" id="clientIdDisplay">ID: UNKNOWN</span>
      </div>
      <div class="system-status">
        <div class="status-dot"></div> <span id="statusText">SYSTEM ONLINE</span>
      </div>
    </div>

    <!-- 1. å…¨å±€è¨­å®š -->
    <div class="module-card">
      <div class="module-title"><i class="fas fa-globe"></i> GLOBAL VARIABLES (å•†åº—è¨­å®š)</div>
      
      <div class="input-group">
        <label class="input-label">å•†åº—åç¨± (TITLE)</label>
        <input type="text" class="cyber-input" id="shopNameInput" placeholder="Default System Name" oninput="updatePreview()">
      </div>

      <div style="display: flex; gap: 20px;">
        <div class="input-group" style="flex:1">
          <label class="input-label">è¯çµ¡é›»è©± (PHONE)</label>
          <input type="text" class="cyber-input" id="phoneInput" placeholder="Empty to hide" oninput="updatePreview()">
        </div>
        <div class="input-group" style="flex:1">
          <label class="input-label">LINE LINK</label>
          <input type="text" class="cyber-input" id="lineInput" placeholder="Empty to hide" oninput="updatePreview()">
        </div>
      </div>
    </div>

    <!-- 2. å°è©±é‚è¼¯ -->
    <div class="module-card">
      <div class="module-title" style="justify-content:space-between">
        <span><i class="fas fa-brain"></i> NEURAL RESPONSES (å•ç­”è¨­å®š)</span>
        <button class="btn-action" onclick="addQA()"><i class="fas fa-plus"></i> ADD NODE</button>
      </div>
      <div id="qaEditorList">
        <!-- JS å‹•æ…‹ç”Ÿæˆ QA å€å¡Š -->
      </div>
    </div>

    <button class="btn-deploy" id="saveBtn" onclick="saveQA()">
      <i class="fas fa-cloud-upload-alt"></i> DEPLOY TO SERVER (å„²å­˜è¨­å®š)
    </button>
    <div style="text-align:center; margin-top:10px; font-size:11px; color:#555;">
      SECURE CONNECTION VIA GOOGLE APPS SCRIPT
    </div>
  </div>

  <!-- å³å´ï¼šæ¨¡æ“¬å™¨ -->
  <div class="preview-zone">
    <div class="phone-mockup">
      <div class="notch"></div>
      <div class="sim-screen">
        <div class="sim-overlay"></div>
        <div class="sim-content">
          <!-- é ‚éƒ¨è³‡è¨Š -->
          <div class="sim-top-bar">
            <div class="sim-title" id="simTitle">Store Name</div>
            <div class="sim-capsules">
              <div class="sim-capsule" id="simPhone"><i class="fas fa-phone"></i></div>
              <div class="sim-capsule" id="simLine">LINE</div>
            </div>
          </div>

          <!-- å°è©±å…§å®¹ -->
          <div class="sim-chat">
            <div class="sim-bubble bot">
              <div id="simWelcome">Welcome Message</div>
              <div class="sim-chips" id="simChips"></div>
            </div>
          </div>

          <!-- åº•éƒ¨è¼¸å…¥æ¡†æ¨¡æ“¬ -->
          <div style="position:absolute; bottom:20px; left:50%; transform:translateX(-50%); width:90%; height:40px; background:rgba(255,255,255,0.2); backdrop-filter:blur(10px); border-radius:20px; border:1px solid rgba(255,255,255,0.1);"></div>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
  // ğŸ”´ ä½ çš„ GAS ç¶²å€ (é‚è¼¯ä¿ç•™)
  const API_URL = "https://script.google.com/macros/s/AKfycbz7IJ4YuR2GkR5m61Z8l2TZoqtIy9g7r-YPB1Xx_31gZhkhvZ01N8LTux5jqIzULXdvXw/exec"; 

  const urlParams = new URLSearchParams(window.location.search);
  const CLIENT_ID = urlParams.get('id');

  // æœ¬åœ°ç‹€æ…‹ç®¡ç†
  let appState = {
    qaList: [],
    industry: '',
    shopName: '',
    phone: '',
    line: '',
    welcomeMsg: 'æ­¡è¿å…‰è‡¨ï¼' // é è¨­æ­¡è¿è©
  };

  // é è¨­è³‡æ–™ (Fallback)
  const industries = {
    pc_repair: { name: "é›»è…¦ç¶­ä¿®", welcome: "é›»è…¦é–‹ä¸äº†æ©Ÿï¼Ÿ", faqs: [{q:"é–‹ä¸äº†æ©Ÿ",a:"è«‹æª¢æŸ¥é›»æºç·š..."}] },
    beauty: { name: "ç¾å®¹ç¾é«®", welcome: "æƒ³æ›å€‹æ–°é€ å‹å—ï¼Ÿ", faqs: [{q:"é ç´„å‰ªé«®",a:"è«‹å•æƒ³é ç´„å“ªä½è¨­è¨ˆå¸«ï¼Ÿ"}] },
    restaurant: { name: "é¤é£²ç¾é£Ÿ", welcome: "ä»Šæ™šæƒ³åƒé»ä»€éº¼ï¼Ÿ", faqs: [{q:"è¨‚ä½",a:"å¹¾ä½ç”¨é¤ï¼Ÿ"}] },
    real_estate: { name: "æˆ¿ç”¢é¡§å•", welcome: "å°‹æ‰¾å¤¢æƒ³å®¶åœ’ï¼Ÿ", faqs: [{q:"æœ€æ–°ç‰©ä»¶",a:"..."}] },
    gym: { name: "å¥èº«æ•™ç·´", welcome: "æº–å‚™å¥½æµæ±—äº†å—ï¼Ÿ", faqs: [] },
    car: { name: "æ±½è»Šä¿ä¿®", welcome: "è»Šå­æœ‰ç•°éŸ³ï¼Ÿ", faqs: [] },
    shop: { name: "ç¶²æ‹å®¢æœ", welcome: "æŸ¥è©¢è¨‚å–®ï¼Ÿ", faqs: [] },
    clinic: { name: "è¨ºæ‰€æ›è™Ÿ", welcome: "éœ€è¦æ›è™Ÿå—ï¼Ÿ", faqs: [] },
    plumbing: { name: "æ°´é›»ç¶­ä¿®", welcome: "å“ªè£¡æ¼æ°´äº†ï¼Ÿ", faqs: [] },
    tutor: { name: "è£œç¿’ç­", welcome: "èª²ç¨‹è«®è©¢ï¼Ÿ", faqs: [] }
  };

  // --- åˆå§‹åŒ– ---
  async function init() {
    if (!CLIENT_ID) {
      document.querySelector('.loading-overlay').innerHTML = `<p style="color:var(--danger)">ERROR: MISSING ID PARAMETER</p>`;
      return;
    }

    document.getElementById('clientIdDisplay').innerText = `ID: ${CLIENT_ID.substring(0,6)}...`;

    try {
      const res = await fetch(`${API_URL}?action=check_auth&client_id=${CLIENT_ID}`);
      const data = await res.json();

      if (data.status === 'error') {
        alert("ACCESS DENIED: ç„¡æ•ˆçš„ ID");
        return;
      }

      // è¼‰å…¥æ•¸æ“š
      appState.industry = data.industry;
      appState.shopName = data.shop_name || "";
      appState.phone = data.phone || "";
      appState.line = data.line || "";

      // æ ¹æ“šè¡Œæ¥­è¨­å®šé è¨­æ­¡è¿èª (è‹¥æœ‰)
      if (appState.industry && industries[appState.industry]) {
         appState.welcomeMsg = industries[appState.industry].welcome;
         // å¦‚æœåç¨±æ˜¯ç©ºçš„ï¼Œç”¨è¡Œæ¥­é è¨­
         if (!appState.shopName) appState.shopName = industries[appState.industry].name;
      }

      // QA è¼‰å…¥é‚è¼¯
      if (data.custom_qa && data.custom_qa.length > 0) {
        appState.qaList = data.custom_qa;
      } else if (data.industry && industries[data.industry]) {
        appState.qaList = industries[data.industry].faqs;
      } else {
        appState.qaList = [{q: "ç¯„ä¾‹æŒ‰éˆ•", a: "ç¯„ä¾‹å›ç­”"}];
      }

      // å¡«å…… UI
      document.getElementById("shopNameInput").value = appState.shopName;
      document.getElementById("phoneInput").value = appState.phone;
      document.getElementById("lineInput").value = appState.line;
      document.getElementById("statusText").innerText = `CONNECTED: ${data.industry.toUpperCase()}`;
      
      renderEditor();
      updatePreview(); // é¦–æ¬¡æ¸²æŸ“é è¦½

      // ç§»é™¤ Loading
      setTimeout(() => {
        document.getElementById('loadingScreen').style.opacity = '0';
        setTimeout(() => document.getElementById('loadingScreen').style.display = 'none', 500);
      }, 800);

    } catch (e) {
      console.error(e);
      document.querySelector('.loading-overlay p').innerText = "CONNECTION FAILED";
      document.querySelector('.loading-overlay p').style.color = "var(--danger)";
    }
  }

  // --- æ¸²æŸ“ç·¨è¼¯å™¨ (å·¦å´) ---
  function renderEditor() {
    const list = document.getElementById('qaEditorList');
    list.innerHTML = "";

    appState.qaList.forEach((item, index) => {
      const div = document.createElement('div');
      div.className = 'qa-block';
      div.innerHTML = `
        <div class="qa-header">
          <div class="input-group" style="margin:0; width:70%">
             <input type="text" class="cyber-input" value="${item.q}" 
               placeholder="æŒ‰éˆ•æ–‡å­— (User sees this)" 
               oninput="updateQA(${index}, 'q', this.value)"
               style="font-weight:bold; color:var(--accent);">
          </div>
          <button class="btn-action btn-delete" onclick="delQA(${index})"><i class="fas fa-trash"></i></button>
        </div>
        <textarea class="qa-textarea" placeholder="æ©Ÿå™¨äººå›ç­” (Bot replies this)..." 
          oninput="updateQA(${index}, 'a', this.value)">${item.a}</textarea>
      `;
      list.appendChild(div);
    });
  }

  // --- æ•¸æ“šæ›´æ–°èˆ‡å¯¦æ™‚é è¦½ ---
  function updateQA(index, key, value) {
    appState.qaList[index][key] = value;
    updatePreview(); // æ ¸å¿ƒï¼šå³æ™‚é€£å‹•
  }

  function addQA() {
    appState.qaList.push({ q: "æ–°é¸é …", a: "è«‹è¼¸å…¥å›æ‡‰..." });
    renderEditor();
    updatePreview();
  }

  function delQA(index) {
    if(confirm('TERMINATE THIS NODE? (ç¢ºå®šåˆªé™¤æ­¤å•ç­”?)')) {
      appState.qaList.splice(index, 1);
      renderEditor();
      updatePreview();
    }
  }

  // --- é è¦½é‚è¼¯ (å³å´) ---
  function updatePreview() {
    // 1. åŒæ­¥è®Šæ•¸
    appState.shopName = document.getElementById("shopNameInput").value;
    appState.phone = document.getElementById("phoneInput").value;
    appState.line = document.getElementById("lineInput").value;

    // 2. æ›´æ–°æ¨™é¡Œ
    document.getElementById("simTitle").innerText = appState.shopName || "Store Name";
    document.getElementById("simWelcome").innerText = appState.welcomeMsg;
    
    // 3. æ›´æ–°è† å›ŠæŒ‰éˆ•
    const phoneCap = document.getElementById("simPhone");
    const lineCap = document.getElementById("simLine");
    
    phoneCap.style.display = appState.phone ? "inline-block" : "none";
    lineCap.style.display = appState.line ? "inline-block" : "none";

    // 4. æ›´æ–°å¿«æ·é¸å–® (Chips)
    const chipsContainer = document.getElementById("simChips");
    chipsContainer.innerHTML = "";
    appState.qaList.forEach(item => {
      const chip = document.createElement("div");
      chip.className = "sim-chip";
      chip.innerText = item.q;
      chipsContainer.appendChild(chip);
    });
  }

  // --- éƒ¨ç½² (å„²å­˜) ---
  async function saveQA() {
    const btn = document.getElementById('saveBtn');
    const originalText = btn.innerHTML;
    
    // è¦–è¦ºåé¥‹
    btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> UPLOADING DATA...`;
    btn.disabled = true;

    try {
      await fetch(API_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'save_qa',
          client_id: CLIENT_ID,
          qa_list: appState.qaList,
          shop_name: appState.shopName,
          phone: appState.phone,
          line: appState.line
        })
      });
      
      // æ¨¡æ“¬æˆåŠŸ (å› ç‚º no-cors)
      setTimeout(() => {
        btn.innerHTML = `<i class="fas fa-check"></i> DEPLOYMENT SUCCESSFUL`;
        btn.style.background = "#34c759";
        
        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.style.background = ""; // Reset
          btn.disabled = false;
        }, 2000);
      }, 1000);

    } catch (e) {
      alert("UPLOAD ERROR: " + e);
      btn.innerHTML = `DEPLOY FAILED`;
      btn.style.background = "#ff3b30";
      setTimeout(() => {
          btn.innerHTML = originalText;
          btn.style.background = "";
          btn.disabled = false;
      }, 2000);
    }
  }

  // å•Ÿå‹•
  init();

</script>
</body>
</html>