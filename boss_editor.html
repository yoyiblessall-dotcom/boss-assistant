<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
<title>STANDALONE CORE | God Mode</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
  :root { --bg-deep: #050505; --text-main: #ffffff; --text-mute: rgba(255, 255, 255, 0.5); --border: rgba(255, 255, 255, 0.1); --glass: rgba(255, 255, 255, 0.03); --accent: #fff; --glow: rgba(255, 255, 255, 0.3); --aurora-1: #4776E6; --aurora-2: #8E54E9; --aurora-3: #4776E6; }
  * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
  body { margin: 0; padding: 0; font-family: 'Space Grotesk', -apple-system, sans-serif; background-color: var(--bg-deep); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; }
  .core-bg { position: absolute; inset: 0; background: radial-gradient(circle at 10% 10%, #1a1a1a, #000); z-index: -2; }
  .aurora-mesh { position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: conic-gradient(from 0deg, transparent, var(--aurora-1) 60deg, transparent 120deg, var(--aurora-2) 180deg, transparent 240deg, var(--aurora-3) 300deg, transparent 360deg); filter: blur(120px); opacity: 0.15; animation: rotate 60s linear infinite; z-index: -1; transition: all 1s ease; }
  @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  .layout { display: flex; width: 100%; height: 100%; position: relative; z-index: 1; transition: transform 0.5s cubic-bezier(0.25, 1, 0.5, 1); }
  .deck { flex: 1; display: flex; flex-direction: column; border-right: 1px solid var(--border); backdrop-filter: blur(20px); max-width: 60%; background: rgba(0,0,0,0.4); transition: opacity 0.3s; }
  .deck-header { padding: 30px 40px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
  .brand { font-size: 24px; font-weight: 700; letter-spacing: 2px; color: #fff; text-shadow: 0 0 20px rgba(255,255,255,0.2); }
  .status { font-size: 12px; color: var(--text-mute); letter-spacing: 1px; display: flex; align-items: center; gap: 8px;}
  .dot { width: 8px; height: 8px; background: #00ff88; border-radius: 50%; box-shadow: 0 0 10px #00ff88; }
  .deck-scroll { flex: 1; overflow-y: auto; padding: 40px; padding-bottom: 100px; }
  .deck-scroll::-webkit-scrollbar { width: 6px; }
  .deck-scroll::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
  .section-title { font-size: 12px; color: var(--text-mute); letter-spacing: 2px; margin-bottom: 20px; text-transform: uppercase; border-left: 2px solid var(--accent); padding-left: 10px; font-weight: 700; }
  .input-group { margin-bottom: 30px; position: relative; }
  .label { font-size: 13px; color: rgba(255,255,255,0.6); margin-bottom: 8px; display: block; }
  .god-input { width: 100%; background: rgba(255,255,255,0.03); border: none; border-bottom: 1px solid var(--border); color: #fff; padding: 12px 0; font-size: 16px; font-family: inherit; transition: 0.3s; }
  .god-input:focus { border-bottom-color: var(--accent); background: rgba(255,255,255,0.06); padding-left: 10px;}
  .god-input.locked { color: var(--accent); opacity: 0.8; font-weight: 700; cursor: not-allowed; border-bottom: 1px dashed var(--border); }
  .color-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-top: 15px; }
  .color-orb { width: 40px; height: 40px; border-radius: 50%; cursor: pointer; position: relative; border: 2px solid rgba(255,255,255,0.1); transition: 0.4s; }
  .color-orb:hover { transform: scale(1.2); z-index: 10; border-color: #fff; }
  .color-orb.active { border-color: #fff; box-shadow: 0 0 20px var(--glow); transform: scale(1.15); }
  .qa-card { background: rgba(255,255,255,0.02); border: 1px solid var(--border); padding: 20px; margin-bottom: 15px; position: relative; transition: 0.3s; border-radius: 6px; }
  .qa-card:hover { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.3); }
  .qa-header { display: flex; gap: 20px; margin-bottom: 15px; align-items: center;}
  .qa-input-s { flex: 1; font-weight: 700; color: var(--accent); }
  .qa-body textarea { width: 100%; background: transparent; border: none; color: rgba(255,255,255,0.8); resize: vertical; min-height: 60px; font-family: inherit; font-size: 14px; line-height: 1.6; border-left: 1px solid var(--border); padding-left: 10px; }
  .btn-icon { background: transparent; border: none; color: #ff3b30; cursor: pointer; opacity: 0.5; transition: 0.2s; }
  .btn-icon:hover { opacity: 1; transform: scale(1.1); }
  .action-deck { margin-top: 20px; display: flex; gap: 15px; }
  .btn-ghost { background: transparent; border: 1px solid var(--border); color: #fff; padding: 10px 20px; cursor: pointer; font-family: inherit; font-size: 12px; letter-spacing: 1px; transition: 0.3s; border-radius: 4px; }
  .btn-ghost:hover { border-color: #fff; background: rgba(255,255,255,0.05); }
  .btn-main { width: 100%; background: #fff; color: #000; border: none; padding: 18px; font-family: inherit; font-weight: 700; font-size: 14px; letter-spacing: 2px; cursor: pointer; margin-top: 20px; transition: 0.3s; box-shadow: 0 0 20px rgba(255,255,255,0.1); border-radius: 4px; }
  .btn-main:hover { transform: translateY(-2px); box-shadow: 0 0 30px rgba(255,255,255,0.3); }
  .btn-main:disabled { opacity: 0.5; cursor: not-allowed; }
  .insight-card { background: rgba(255,255,255,0.02); border: 1px solid var(--border); padding: 20px; margin-bottom: 20px; border-radius: 8px; }
  .insight-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-size: 11px; letter-spacing: 1px; color: var(--accent); font-weight: 700; }
  .btn-refresh { background: transparent; border: none; color: #fff; cursor: pointer; opacity: 0.5; transition: 0.3s; }
  .stat-row { margin-bottom: 12px; }
  .stat-label { font-size: 12px; color: rgba(255,255,255,0.8); margin-bottom: 4px; display: flex; justify-content: space-between;}
  .stat-bar-bg { height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; }
  .stat-bar-fill { height: 100%; background: var(--accent); width: 0%; transition: width 1s ease; box-shadow: 0 0 10px var(--aurora-1); }
  .log-item { border-bottom: 1px solid rgba(255,255,255,0.05); padding: 10px 0; display: flex; flex-direction: column; gap: 4px; }
  .log-time { font-size: 10px; color: var(--text-mute); font-family: monospace; }
  .log-msg { font-size: 13px; color: #fff; }
  .preview-deck { flex: 1; display: flex; align-items: center; justify-content: center; background: radial-gradient(circle, rgba(255,255,255,0.03) 0%, transparent 80%); position: relative; padding: 40px; perspective: 1000px; transition: opacity 0.3s; overflow-y: auto; }
  .phone-frame { height: 85vh; max-height: 800px; aspect-ratio: 9 / 19.5; width: auto; max-width: 90%; background: #000; border-radius: 50px; border: 8px solid #1a1a1a; box-shadow: 0 0 0 2px #333, 0 20px 50px rgba(0,0,0,0.8), 0 0 100px var(--aurora-1); position: relative; overflow: hidden; transition: box-shadow 1s ease; z-index: 10; flex-shrink: 0; }
  .phone-frame::before { content: ''; position: absolute; inset: 0; background: linear-gradient(105deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0) 40%, rgba(255,255,255,0) 60%, rgba(255,255,255,0.02) 100%); pointer-events: none; z-index: 50; border-radius: 42px; }
  .notch { position: absolute; top: 12px; left: 50%; transform: translateX(-50%); width: 30%; height: 28px; background: #000; border-radius: 20px; z-index: 99; display: flex; align-items: center; justify-content: center; gap: 8px; }
  .notch::after { content: ''; width: 8px; height: 8px; background: #1a1a1a; border-radius: 50%; box-shadow: inset 0 0 2px #000; }
  .notch::before { content: ''; width: 8px; height: 8px; background: #080808; border-radius: 50%; }
  .sim-screen { position: absolute; inset: 0; display: flex; flex-direction: column; color: #fff; border-radius: 42px; overflow: hidden; background: #000; }
  .status-bar { height: 50px; padding: 0 25px; display: flex; justify-content: space-between; align-items: flex-end; font-size: 12px; font-weight: 600; padding-bottom: 8px; z-index: 60; color: rgba(255,255,255,0.9); flex-shrink: 0; }
  .home-indicator { position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); width: 35%; height: 5px; background: rgba(255,255,255,0.4); border-radius: 3px; z-index: 100; }
  .sim-aurora { position: absolute; inset: -50%; background: conic-gradient(from 0deg, transparent, var(--aurora-1) 60deg, transparent, var(--aurora-2) 180deg, transparent, var(--aurora-3) 300deg, transparent); filter: blur(50px); opacity: 0.5; animation: rotate 30s linear infinite; z-index: -1; }
  .sim-hud { padding: 10px 20px 10px; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(to bottom, rgba(0,0,0,0.5), transparent); z-index: 10; flex-shrink: 0; }
  .sim-title { font-weight: 700; font-size: 13px; letter-spacing: 0.5px; text-shadow: 0 2px 4px rgba(0,0,0,0.5);}
  .sim-capsule { font-size: 9px; padding: 3px 8px; background: rgba(255,255,255,0.1); backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; }
  .sim-chat { flex: 1; padding: 20px; display: flex; flex-direction: column; justify-content: flex-end; gap: 12px; position: relative; z-index: 5; overflow-y: auto; min-height: 0; }
  .sim-node { max-width: 85%; font-size: 13px; line-height: 1.4; padding: 10px 14px; border-radius: 12px; position: relative; backdrop-filter: blur(5px); animation: slideUp 0.3s ease-out; }
  .sim-node.bot { align-self: flex-start; background: rgba(255,255,255,0.05); border-left: 2px solid var(--accent); color: rgba(255,255,255,0.9); }
  .sim-node.user { align-self: flex-end; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); color: var(--accent); text-align: right; }
  @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  .sim-dock { padding: 0 0 35px 0; background: linear-gradient(to top, #000 40%, transparent); z-index: 10; display: flex; flex-direction: column; gap: 10px; flex-shrink: 0; }
  .sim-chips { display: flex; gap: 8px; overflow-x: auto; padding: 0 20px; scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.3) transparent; }
  .sim-chips::-webkit-scrollbar { height: 4px; }
  .sim-chips::-webkit-scrollbar-track { background: transparent; }
  .sim-chips::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 2px; }
  .sim-chip { flex: 0 0 auto; padding: 8px 14px; background: rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; font-size: 11px; color: rgba(255,255,255,0.9); backdrop-filter: blur(10px); cursor: default; }
  .sim-input { margin: 0 20px; height: 36px; border-bottom: 1px solid rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: space-between; font-size: 12px; color: rgba(255,255,255,0.5); }
  .uplink-layer { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; font-family: 'Space Grotesk', monospace; transition: opacity 0.5s; }
  .loader-ring { width: 50px; height: 50px; border: 2px solid rgba(255,255,255,0.1); border-top-color: #fff; border-radius: 50%; animation: rotate 1s infinite linear; }
  .mobile-toggle-btn { display: none; }
  @media (max-width: 1000px) {
    .layout { flex-direction: row; width: 200vw; transform: translateX(0); }
    .deck { width: 100vw; max-width: 100vw; height: 100vh; border-right: none; }
    .preview-deck { width: 100vw; max-width: 100vw; height: 100vh; padding: 20px; padding-bottom: 120px; align-items: flex-start; overflow-y: auto; }
    .phone-frame { width: 100%; height: auto; aspect-ratio: 9 / 19.5; margin-top: 20px; }
    .deck-header { padding: 20px; }
    .brand { font-size: 18px; }
    .mobile-toggle-btn { display: flex; position: fixed; bottom: 30px; right: 20px; background: rgba(255,255,255,0.1); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.2); padding: 12px 24px; border-radius: 30px; color: #fff; font-weight: 700; font-size: 13px; letter-spacing: 1px; z-index: 9999; box-shadow: 0 10px 30px rgba(0,0,0,0.5); align-items: center; gap: 10px; cursor: pointer; transition: all 0.3s; }
    .mobile-toggle-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.2); }
    .toggle-icon { transition: transform 0.3s; }
    body.view-preview .layout { transform: translateX(-100vw); }
    body.view-preview .mobile-toggle-btn { background: var(--accent); color: #000; }
    body.view-preview .toggle-icon { transform: rotate(180deg); }
  }
  #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000000; z-index: 2147483647 !important; display: none; justify-content: center; align-items: center; flex-direction: column; }
  .login-box { width: 90%; max-width: 400px; background: rgba(20, 20, 20, 0.8); border: 1px solid #333; border-radius: 20px; padding: 40px; text-align: center; backdrop-filter: blur(10px); box-shadow: 0 0 50px rgba(0, 255, 136, 0.1); }
  .login-title { color: #fff; font-size: 20px; margin-bottom: 20px; letter-spacing: 2px; }
  .login-input { width: 100%; padding: 15px; background: #000; border: 1px solid #444; color: #00ff88; font-family: monospace; text-align: center; font-size: 16px; border-radius: 10px; margin-bottom: 20px; outline: none; }
  .login-input:focus { border-color: #00ff88; box-shadow: 0 0 15px rgba(0,255,136,0.2); }
  .login-btn { padding: 12px 30px; background: #00ff88; color: #000; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; transition: 0.3s; }
  .login-btn:hover { transform: scale(1.05); box-shadow: 0 0 20px #00ff88; }
</style>
</head>
<body>

<div id="loginOverlay"><div class="login-box"><div class="login-title">ADMIN ACCESS</div><p style="color:#888; font-size:12px; margin-bottom:20px;">請輸入您的系統 ID (Access Token)</p><input type="text" id="unique_gate_input" class="login-input" placeholder="Paste ID Here..."><button class="login-btn" onclick="executeFinalLogin()">ENTER CORE</button><p style="margin-top:20px; font-size:10px; color:#555;">* 僅限授權人員進入</p></div></div>
<script>
(function(){const p=new URLSearchParams(window.location.search);const i=p.get('id');const o=document.getElementById('loginOverlay');if(i){if(o)o.remove()}else{if(o){o.style.display='flex';const ip=document.getElementById('unique_gate_input');if(ip){ip.addEventListener("keypress",function(e){if(e.key==="Enter"){e.preventDefault();executeFinalLogin()}});setTimeout(()=>ip.focus(),100)}}const s=document.createElement('style');s.innerHTML='body > *:not(#loginOverlay):not(script) { display: none !important; }';document.head.appendChild(s)}})();
function executeFinalLogin(){const el=document.getElementById('unique_gate_input');if(!el)return;const v=el.value.trim();if(v&&v.length>5){window.location.href=window.location.pathname+'?id='+v}else{alert("錯誤：ID 無效！")}}
</script>

<div class="core-bg"></div><div class="aurora-mesh" id="coreMesh"></div>
<div class="uplink-layer" id="uplinkLayer"><div class="loader-ring"></div><div style="margin-top:20px; letter-spacing: 3px; font-size: 12px;">RESTORING DATA...</div></div>

<div class="layout">
  <div class="deck">
    <div class="deck-header"><div class="brand">STANDALONE CORE</div><div class="status"><div class="dot"></div> ONLINE <span id="clientIdDisplay" style="margin-left:10px; opacity:0.5;">ID: --</span></div></div>
    <div class="deck-scroll">
      <div class="section-title">01 / SYSTEM PROTOCOL (系統識別)</div>
      <div class="input-group"><label class="label">DETECTED INDUSTRY (行業協定)</label><input type="text" class="god-input locked" id="industryDisplay" value="SCANNING..." readonly></div>
      <div class="input-group"><label class="label">DISPLAY NAME (顯示名稱)</label><input type="text" class="god-input" id="shopNameInput" oninput="syncPreview()"></div>
      <div class="section-title" style="margin-top:40px;">01.5 / VISUAL CORE (視覺氛圍)</div>
      <div class="input-group"><label class="label">ATMOSPHERE SELECTION (點擊色球切換氛圍)</label><div class="color-grid" id="themeGrid"></div><input type="hidden" id="themeOverrideInput"></div>
      <div style="display:flex; gap:20px;"><div class="input-group" style="flex:1"><label class="label">VOICE UPLINK (電話)</label><input type="text" class="god-input" id="phoneInput" oninput="syncPreview()"></div><div class="input-group" style="flex:1"><label class="label">DATA LINK (LINE 設定)</label><input type="text" class="god-input" id="lineInput" oninput="syncPreview()" placeholder="輸入 ID (如 myid123 或 @shop)"></div></div>
      <div class="section-title" style="margin-top:40px;">02 / NEURAL RESPONSES (對話邏輯)</div>
      <div id="qaList"></div>
      <div class="action-deck"><button class="btn-ghost" onclick="addQA()">+ ADD NODE</button></div>
      <div class="section-title" style="margin-top:40px;">03 / DATA INSIGHTS (數據洞察)</div>
      <div class="insight-card"><div class="insight-header"><span>TOP QUESTIONS (熱門按鈕排行)</span><button class="btn-refresh" onclick="loadAnalytics()"><i class="fas fa-sync-alt"></i></button></div><div id="statsBarChart" class="stats-container"><div style="text-align:center; padding:20px; color:#666;">LOADING DATA...</div></div></div>
      <div class="insight-card"><div class="insight-header"><span>RECENT TEXT INPUTS (最近文字提問)</span></div><div id="textLogs" class="logs-container"><div style="text-align:center; padding:20px; color:#666;">WAITING FOR SYNC...</div></div></div>
      <button class="btn-main" id="saveBtn" onclick="saveData()">DEPLOY CHANGES</button>
      <div style="text-align:center; margin-top:15px; font-size:10px; color:#555;">SECURE CONNECTION VIA GOOGLE CLOUD</div>
    </div>
  </div>
  <div class="preview-deck">
    <div class="phone-frame" id="phoneFrame"><div class="status-bar"><span>09:41</span><div style="display:flex; gap:5px;"><i class="fas fa-signal"></i><i class="fas fa-wifi"></i><i class="fas fa-battery-full"></i></div></div><div class="notch"></div><div class="sim-screen"><div class="sim-aurora" id="simAurora"></div><div class="sim-hud"><div class="sim-title" id="simTitle">LOADING...</div><div style="display:flex; gap:5px;"><div class="sim-capsule" id="simPhone" style="display:none"><i class="fas fa-phone"></i></div><div class="sim-capsule" id="simLine" style="display:none"><i class="fab fa-line"></i></div></div></div><div class="sim-chat" id="simChatBody"></div><div class="sim-dock"><div class="sim-chips" id="simChips"></div><div class="sim-input"><span>Enter command...</span><span style="font-weight:700; color:var(--accent)">SEND</span></div></div></div><div class="home-indicator"></div></div>
  </div>
</div>
<div class="mobile-toggle-btn" onclick="toggleView()"><span id="toggleText">前往預覽</span><i class="fas fa-arrow-right toggle-icon"></i></div>

<script>
const _raw = [104,116,116,112,115,58,47,47,115,99,114,105,112,116,46,103,111,111,103,108,101,46,99,111,109,47,109,97,99,114,111,115,47,115,47,65,75,102,121,99,98,122,55,73,74,52,89,117,82,50,71,107,82,53,109,54,49,90,56,108,50,84,90,111,113,116,73,121,57,103,55,114,45,89,80,66,49,88,120,95,51,49,103,90,104,107,104,118,90,48,49,78,56,76,84,117,120,53,106,113,73,122,85,76,88,100,118,88,119,47,101,120,101,99];
const API_URL = String.fromCharCode(..._raw);

const urlParams = new URLSearchParams(window.location.search);
const CLIENT_ID = urlParams.get('id');
const themes = {
  pc_repair: { name: "電腦維修 // TECH", vars: { "--aurora-1": "#00f260", "--aurora-2": "#0575e6", "--aurora-3": "#00f260", "--accent": "#00f260", "--glow": "rgba(0, 242, 96, 0.4)" }, welcome: "系統檢測中... 請問您的電腦遇到什麼狀況？", faqs: [{q:"無法開機",a:"請檢查電源插頭與指示燈是否亮起。"}, {q:"電腦變慢",a:"建議清理磁碟或升級 SSD 硬碟。"}, {q:"疑似中毒",a:"請立即斷開網路並重新啟動。"}] },
  restaurant: { name: "精緻餐飲 // FOOD", vars: { "--aurora-1": "#ff416c", "--aurora-2": "#ff4b1f", "--aurora-3": "#ff9068", "--accent": "#ff9068", "--glow": "rgba(255, 144, 104, 0.4)" }, welcome: "歡迎光臨，為您安排美好的一餐。", faqs: [{q:"我要訂位",a:"請告知用餐人數與時間。"}, {q:"主廚推薦",a:"今日推薦：黑松露野菇燉飯。"}] },
  beauty: { name: "時尚美學 // VOGUE", vars: { "--aurora-1": "#833ab4", "--aurora-2": "#fd1d1d", "--aurora-3": "#fcb045", "--accent": "#da77f2", "--glow": "rgba(218, 119, 242, 0.4)" }, welcome: "您好，想換個新造型嗎？", faqs: [{q:"預約剪髮",a:"請問想預約哪位設計師？"}, {q:"價目表",a:"洗剪服務 800 元起。"}] },
  real_estate: { name: "房產顧問 // ESTATE", vars: { "--aurora-1": "#CAC531", "--aurora-2": "#F3F9A7", "--aurora-3": "#8E8D8A", "--accent": "#F3F9A7", "--glow": "rgba(243, 249, 167, 0.4)" }, welcome: "正在為您搜尋理想物件。", faqs: [{q:"最新物件",a:"目前市中心有幾間不錯的物件..."}, {q:"預約看房",a:"請留下您的聯絡電話。"}] },
  gym: { name: "健身教練 // GYM", vars: { "--aurora-1": "#11998e", "--aurora-2": "#38ef7d", "--aurora-3": "#000000", "--accent": "#38ef7d", "--glow": "rgba(56, 239, 125, 0.4)" }, welcome: "準備好流汗了嗎？", faqs: [{q:"會籍費用",a:"月費 988 元起，免入會費。"}, {q:"私人教練",a:"目前有體驗課程優惠中。"}] },
  car: { name: "汽車保修 // AUTO", vars: { "--aurora-1": "#2C3E50", "--aurora-2": "#4CA1AF", "--aurora-3": "#C4E0E5", "--accent": "#4CA1AF", "--glow": "rgba(76, 161, 175, 0.4)" }, welcome: "車子有異音？該保養了？", faqs: [{q:"定期保養",a:"建議每 5000 公里回廠保養。"}, {q:"道路救援",a:"緊急情況請撥打客服電話。"}] },
  shop: { name: "網拍客服 // SHOP", vars: { "--aurora-1": "#FF512F", "--aurora-2": "#DD2476", "--aurora-3": "#FF512F", "--accent": "#FF512F", "--glow": "rgba(255, 81, 47, 0.4)" }, welcome: "您好！關於訂單或退換貨問題？", faqs: [{q:"訂單查詢",a:"請提供您的訂單編號。"}, {q:"退換貨",a:"七天鑑賞期內可申請退換。"}] },
  clinic: { name: "診所掛號 // MED", vars: { "--aurora-1": "#00d2ff", "--aurora-2": "#3a7bd5", "--aurora-3": "#00d2ff", "--accent": "#00d2ff", "--glow": "rgba(0, 210, 255, 0.4)" }, welcome: "早安，需要掛號或健康諮詢嗎？", faqs: [{q:"門診時間",a:"早診 9:00 - 12:00，午診 14:00 - 17:00。"}, {q:"掛號",a:"請提供身分證字號。"}] },
  plumbing: { name: "水電維修 // FIX", vars: { "--aurora-1": "#1A2980", "--aurora-2": "#26D0CE", "--aurora-3": "#1A2980", "--accent": "#26D0CE", "--glow": "rgba(38, 208, 206, 0.4)" }, welcome: "哪裡漏水了？我們馬上過去處理。", faqs: [{q:"馬桶不通",a:"我們有專業設備可協助疏通。"}, {q:"更換水龍頭",a:"有多種款式可供選擇。"}] },
  tutor: { name: "補習班 // STUDY", vars: { "--aurora-1": "#4776E6", "--aurora-2": "#8E54E9", "--aurora-3": "#4776E6", "--accent": "#8E54E9", "--glow": "rgba(142, 84, 233, 0.4)" }, welcome: "想了解什麼課程？", faqs: [{q:"課程試聽",a:"歡迎預約免費試聽課程。"}, {q:"收費方式",a:"詳細費用請洽櫃台諮詢。"}] }
};
let appState = { industry: 'pc_repair', shopName: '', phone: '', line: '', qaList: [], welcome: '', themeOverride: '' };
let isPreviewMode = false;
function toggleView() {
  isPreviewMode = !isPreviewMode;
  document.body.classList.toggle('view-preview', isPreviewMode);
  const btnText = document.getElementById('toggleText'); const icon = document.querySelector('.toggle-icon');
  if(isPreviewMode) { btnText.innerText = "返回編輯"; icon.className = "fas fa-arrow-left toggle-icon"; } else { btnText.innerText = "前往預覽"; icon.className = "fas fa-arrow-right toggle-icon"; }
}
async function init() {
  if (!CLIENT_ID) { document.getElementById('uplinkLayer').style.display = 'none'; document.getElementById('industryDisplay').value = "WAITING FOR LOGIN..."; return; }
  document.getElementById('clientIdDisplay').innerText = `ID: ${CLIENT_ID.substring(0,8)}...`;
  try {
    const res = await fetch(`${API_URL}?action=check_auth&client_id=${CLIENT_ID}`);
    const data = await res.json();
    if (data.status === 'error') return alert("ACCESS DENIED");
    appState.industry = data.industry || 'pc_repair'; appState.shopName = data.shop_name || ''; appState.phone = data.phone || ''; appState.line = data.line || ''; appState.themeOverride = data.theme_preference || ''; 
    if (data.custom_qa && data.custom_qa.length > 0) { appState.qaList = data.custom_qa; } else if (themes[appState.industry]) { appState.qaList = themes[appState.industry].faqs; }
    appState.welcome = themes[appState.industry].welcome;
    const themeName = themes[appState.industry].name;
    document.getElementById('industryDisplay').value = themeName; document.getElementById('shopNameInput').value = appState.shopName; document.getElementById('phoneInput').value = appState.phone; document.getElementById('lineInput').value = appState.line;
    renderQA(); renderThemeSelector(); applyVisuals(appState.themeOverride || appState.industry); syncPreview(); loadAnalytics();
    document.getElementById('uplinkLayer').style.display = 'none';
  } catch (e) { console.error(e); alert("CONNECTION FAILED"); }
}
function manualSwitch(key) { appState.industry = key; appState.qaList = JSON.parse(JSON.stringify(themes[key].faqs)); appState.welcome = themes[key].welcome; if(!appState.shopName) document.getElementById('shopNameInput').value = themes[key].name; renderQA(); renderThemeSelector(); applyVisuals(key); syncPreview(); }
function renderThemeSelector() {
  const grid = document.getElementById('themeGrid'); grid.innerHTML = "";
  for (const [key, val] of Object.entries(themes)) {
    const btn = document.createElement('div'); const isActive = (appState.themeOverride === key) || (!appState.themeOverride && appState.industry === key);
    btn.className = `color-orb ${isActive ? 'active' : ''}`; btn.style.background = `conic-gradient(${val.vars['--aurora-1']}, ${val.vars['--aurora-2']})`; btn.title = val.name; 
    btn.onclick = () => { document.querySelectorAll('.color-orb').forEach(b => b.classList.remove('active')); btn.classList.add('active'); appState.themeOverride = key; document.getElementById('themeOverrideInput').value = key; applyVisuals(key); };
    grid.appendChild(btn);
  }
}
function applyVisuals(key) {
  const t = themes[key]; const root = document.documentElement; for (const [k, v] of Object.entries(t.vars)) { root.style.setProperty(k, v); }
  const frame = document.getElementById('phoneFrame'); frame.style.boxShadow = `0 0 0 2px #333, 0 20px 50px rgba(0,0,0,0.8), 0 0 100px ${t.vars["--aurora-1"]}`;
}
function renderQA() {
  const list = document.getElementById('qaList'); list.innerHTML = "";
  appState.qaList.forEach((item, index) => {
    const card = document.createElement('div'); card.className = 'qa-card';
    card.innerHTML = `<div class="qa-header"><input type="text" class="god-input qa-input-s" value="${item.q}" oninput="updateQA(${index}, 'q', this.value)" placeholder="按鈕文字"><button class="btn-icon" onclick="delQA(${index})"><i class="fas fa-trash"></i></button></div><div class="qa-body"><textarea oninput="updateQA(${index}, 'a', this.value)" placeholder="回應內容...">${item.a}</textarea></div>`;
    list.appendChild(card);
  });
}
function updateQA(index, key, val) { appState.qaList[index][key] = val; syncPreview(); }
function addQA() { appState.qaList.push({q: "新選項", a: "請輸入回應..."}); renderQA(); syncPreview(); }
function delQA(index) { if(confirm("DELETE NODE?")) { appState.qaList.splice(index, 1); renderQA(); syncPreview(); } }
function syncPreview() {
  const name = document.getElementById('shopNameInput').value || themes[appState.industry].name;
  const ph = document.getElementById('phoneInput').value; const ln = document.getElementById('lineInput').value;
  document.getElementById('simTitle').innerText = name; document.getElementById('simPhone').style.display = ph ? 'flex' : 'none'; document.getElementById('simLine').style.display = ln ? 'flex' : 'none';
  const chipContainer = document.getElementById('simChips'); chipContainer.innerHTML = "";
  appState.qaList.forEach(item => { const chip = document.createElement("div"); chip.className = "sim-chip"; chip.innerText = item.q; chipContainer.appendChild(chip); });
  const chatBody = document.getElementById('simChatBody'); chatBody.innerHTML = `<div class="sim-node bot">${appState.welcome}</div><div class="sim-node user" style="opacity:0.6">...</div>`;
}
async function saveData() {
  const btn = document.getElementById('saveBtn'); const oldText = btn.innerText;
  let rawLine = document.getElementById('lineInput').value.trim(); let finalLineUrl = rawLine;
  if (rawLine && !rawLine.startsWith('http') && !rawLine.startsWith('line://')) { if (rawLine.startsWith('@')) { finalLineUrl = `https://line.me/R/ti/p/${rawLine}`; } else { finalLineUrl = `https://line.me/ti/p/~${rawLine}`; } }
  btn.innerText = "UPLOADING..."; btn.disabled = true;
  const finalData = { action: 'save_qa', client_id: CLIENT_ID, qa_list: appState.qaList, shop_name: document.getElementById('shopNameInput').value, phone: document.getElementById('phoneInput').value, line: finalLineUrl, theme_preference: appState.themeOverride };
  try { await fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(finalData) }); setTimeout(() => { btn.innerText = "SUCCESS"; btn.style.background = "#00ff88"; btn.style.color = "#000"; setTimeout(() => { btn.innerText = oldText; btn.style.background = "#fff"; btn.disabled = false; }, 2000); }, 1000); } catch (e) { alert("UPLOAD ERROR"); btn.disabled = false; }
}
async function loadAnalytics() {
  if (!CLIENT_ID) return; const barContainer = document.getElementById('statsBarChart'); const logContainer = document.getElementById('textLogs');
  barContainer.innerHTML = `<div class="loader-ring" style="width:20px;height:20px;margin:10px auto;"></div>`;
  try {
    const res = await fetch(`${API_URL}?action=get_analytics&client_id=${CLIENT_ID}`); const data = await res.json();
    if (data.status === 'success') {
      if (data.top_buttons.length === 0) { barContainer.innerHTML = `<div style="text-align:center;font-size:12px;opacity:0.5;">NO DATA YET</div>`; } else {
        barContainer.innerHTML = ""; const maxCount = data.top_buttons[0].count;
        data.top_buttons.forEach(item => { const percent = (item.count / maxCount) * 100; const row = document.createElement('div'); row.className = 'stat-row'; row.innerHTML = `<div class="stat-label"><span>${item.label}</span><span>${item.count}次</span></div><div class="stat-bar-bg"><div class="stat-bar-fill" style="width:${percent}%"></div></div>`; barContainer.appendChild(row); });
      }
      if (data.recent_texts.length === 0) { logContainer.innerHTML = `<div style="text-align:center;font-size:12px;opacity:0.5;">NO TEXT INPUTS</div>`; } else {
        logContainer.innerHTML = ""; data.recent_texts.forEach(item => { const row = document.createElement('div'); row.className = 'log-item'; row.innerHTML = `<div class="log-time">${item.time}</div><div class="log-msg">"${item.msg}"</div>`; logContainer.appendChild(row); });
      }
    }
  } catch (e) { console.error(e); barContainer.innerHTML = "LOAD FAILED"; }
}
init();
</script>
</body>
</html>