<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ™ºèƒ½å®¢æœåŠ©æ‰‹</title>
<style>
  :root { --primary-color: #005bac; --text-color: #333; }
  body { font-family: "Microsoft JhengHei", sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }

  /* æ¼”ç¤ºé¢æ¿ (åƒ…Demoæ™‚é¡¯ç¤º) */
  .admin-panel { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
  .industry-select { padding: 10px; width: 100%; max-width: 300px; font-size: 16px; margin-top: 10px;}

  /* æ­¡è¿é¢æ¿ (Liveæ™‚é¡¯ç¤º) */
  .welcome-panel { display: none; text-align: center; margin-top: 100px; color: #555; }
  .welcome-panel h2 { font-size: 28px; color: var(--primary-color); margin-bottom: 10px; }

  /* æ‡¸æµ®æŒ‰éˆ• */
  .float-btn { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; border-radius: 50%; background: var(--primary-color); color: white; display: flex; align-items: center; justify-content: center; font-size: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); cursor: pointer; z-index: 9999; transition: transform 0.3s; }
  .float-btn:hover { transform: scale(1.1); }

  /* èŠå¤©è¦–çª— */
  .chat-window { position: fixed; bottom: 100px; right: 30px; width: 380px; max-width: 90vw; height: 600px; max-height: 80vh; background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); display: none; flex-direction: column; overflow: hidden; z-index: 9998; border: 1px solid #e0e0e0; }
  .chat-header { background: var(--primary-color); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
  
  /* è¯çµ¡å·¥å…·åˆ— (é›»è©±/LINE) */
  .contact-bar { display: none; padding: 10px; background: #f8f9fa; border-bottom: 1px solid #eee; gap: 10px; }
  .contact-btn { flex: 1; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 5px; text-decoration: none; color: white; transition: 0.2s; }
  .btn-phone { background: #4caf50; }
  .btn-phone:hover { background: #43a047; }
  .btn-line { background: #00c300; }
  .btn-line:hover { background: #00b300; }

  .chat-body { flex: 1; padding: 15px; overflow-y: auto; background: #f9f9f9; }
  .message { display: flex; margin-bottom: 15px; }
  .message.user { justify-content: flex-end; }
  .bubble { max-width: 80%; padding: 10px 14px; border-radius: 12px; font-size: 15px; line-height: 1.5; word-wrap: break-word; }
  .bot .bubble { background: white; border: 1px solid #eee; border-top-left-radius: 2px; }
  .user .bubble { background: var(--primary-color); color: white; border-top-right-radius: 2px; }
  
  .quick-menu { padding: 10px; background: white; white-space: nowrap; overflow-x: auto; border-top: 1px solid #eee; }
  .menu-btn { display: inline-block; padding: 8px 16px; margin-right: 8px; background: white; border: 1px solid var(--primary-color); color: var(--primary-color); border-radius: 20px; cursor: pointer; font-size: 13px; }
  .menu-btn:hover { background: var(--primary-color); color: white; }
  
  .input-area { padding: 10px; background: white; border-top: 1px solid #eee; display: flex; gap: 8px; }
  .text-input { flex: 1; padding: 10px; border-radius: 20px; border: 1px solid #ddd; outline: none; }
  .send-btn { background: var(--primary-color); color: white; border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;}
</style>
</head>
<body>

<!-- 1. æ¼”ç¤ºé¢æ¿ -->
<div class="admin-panel" id="adminPanel">
  <h2>ğŸ’¼ è€é—†å°å‰¯æ‰‹ - ç³»çµ±é€£ç·šä¸­</h2>
  <div style="padding:10px; background:#f0f0f0; border-radius:8px; margin-bottom:15px;">
    <strong>ç³»çµ±ç‹€æ…‹ï¼š</strong> <span id="statusText">æ­£åœ¨å‘¼å« ç¥é€¸yoyi æœå‹™ç«¯...</span>
  </div>
  <div id="demoControls">
    <label>å°ˆå±¬è²´è³“åˆ‡æ›ï¼š</label><br>
    <select class="industry-select" id="industrySelect" onchange="manualSwitch()">
      <option value="pc_repair">1. é›»è…¦ç¶­ä¿®</option>
      <option value="restaurant">2. é¤é£²ç¾é£Ÿ</option>
      <option value="beauty">3. ç¾å®¹ç¾é«®</option>
      <option value="real_estate">4. æˆ¿åœ°ç”¢</option>
      <option value="gym">5. å¥èº«æˆ¿</option>
      <option value="car">6. æ±½è»Šä¿ä¿®</option>
      <option value="shop">7. ç¶²æ‹é›»å•†</option>
      <option value="clinic">8. è¨ºæ‰€æ›è™Ÿ</option>
      <option value="plumbing">9. æ°´é›»ç¶­ä¿®</option>
      <option value="tutor">10. è£œç¿’ç­</option>
    </select>
  </div>
</div>

<!-- 2. æ­¡è¿é¢æ¿ -->
<div class="welcome-panel" id="welcomePanel">
  <h2 id="welcomeTitle">ğŸ‘‹ æ­¡è¿ä½¿ç”¨</h2>
  <p>ç³»çµ±é€£ç·šæˆåŠŸï¼Œè«‹é»æ“Šå³ä¸‹è§’æŒ‰éˆ•é–‹å§‹æœå‹™ã€‚</p>
</div>

<!-- 3. èŠå¤©ä¸»é«” -->
<div class="float-btn" id="floatBtn" onclick="toggleChat()">ğŸ’¬</div>

<div class="chat-window" id="chatWindow">
  <div class="chat-header">
    <span id="botTitle">å®¢æœåŠ©æ‰‹</span>
    <span style="cursor:pointer" onclick="toggleChat()">âœ•</span>
  </div>
  
  <!-- è¯çµ¡å·¥å…·åˆ— -->
  <div class="contact-bar" id="contactBar">
    <a href="#" class="contact-btn btn-phone" id="btnPhone">ğŸ“ æ’¥æ‰“é›»è©±</a>
    <a href="#" class="contact-btn btn-line" id="btnLine" target="_blank">ğŸ’¬ åŠ  LINE</a>
  </div>

  <div class="chat-body" id="chatBody"></div>
  <div class="quick-menu" id="quickMenu"></div>
  <div class="input-area">
    <input type="text" class="text-input" id="userInput" placeholder="è«‹è¼¸å…¥å•é¡Œ...">
    <button class="send-btn" onclick="sendMessage()">â¤</button>
  </div>
</div>

<script>
// ğŸ”´ è«‹åœ¨é€™è£¡å¡«å…¥ä½ çš„ GAS ç¶²å€ ğŸ”´
const API_URL = "https://script.google.com/macros/s/AKfycbz7IJ4YuR2GkR5m61Z8l2TZoqtIy9g7r-YPB1Xx_31gZhkhvZ01N8LTux5jqIzULXdvXw/exec"; 

const urlParams = new URLSearchParams(window.location.search);
const CLIENT_ID = urlParams.get('id');

const industries = {
  pc_repair: { name: "é›»è…¦ç¶­ä¿® å°å‰¯æ‰‹", color: "#005bac", icon: "ğŸ’»", welcome: "å—¨ï¼é›»è…¦é–‹ä¸äº†æ©Ÿé‚„æ˜¯ä¸­æ¯’ï¼Ÿ", faqs: [{q:"é–‹ä¸äº†æ©Ÿ",a:"è«‹æª¢æŸ¥æ’é ­..."}] },
  restaurant: { name: "ç¾å‘³é£Ÿå ‚", color: "#ff6b35", icon: "ğŸ”", welcome: "æ­¡è¿å…‰è‡¨ï¼æƒ³è¨‚ä½é‚„æ˜¯çœ‹èœå–®ï¼Ÿ", faqs: [{q:"æˆ‘è¦è¨‚ä½",a:"è«‹å‘ŠçŸ¥äººæ•¸..."}] },
  beauty: { name: "æ™‚å°šç¾å­¸", color: "#e91e63", icon: "ğŸ’…", welcome: "å“ˆå›‰ï½æƒ³æ›å€‹æ–°é€ å‹å—ï¼Ÿ", faqs: [{q:"é ç´„å‰ªé«®",a:"æƒ³é ç´„å“ªä½è¨­è¨ˆå¸«ï¼Ÿ"}] },
  real_estate: { name: "æˆ¿ç”¢é¡§å•", color: "#c5a059", icon: "ğŸ ", welcome: "æ‚¨å¥½ï¼Œæƒ³è²·æˆ¿é‚„æ˜¯è³£æˆ¿ï¼Ÿ", faqs: [{q:"æœ€æ–°ç‰©ä»¶",a:"ç›®å‰æœ‰..."}] },
  gym: { name: "å¥èº«æ•™ç·´", color: "#4caf50", icon: "ğŸ’ª", welcome: "å‹•èµ·ä¾†ï¼æƒ³äº†è§£æœƒç±æ–¹æ¡ˆå—ï¼Ÿ", faqs: [{q:"æœƒç±è²»ç”¨",a:"æœˆè²»988..."}] },
  car: { name: "æ±½è»Šä¿ä¿®", color: "#607d8b", icon: "ğŸš—", welcome: "è»Šå­æœ‰ç•°éŸ³ï¼Ÿè©²ä¿é¤Šäº†ï¼Ÿ", faqs: [{q:"å®šæœŸä¿é¤Š",a:"å»ºè­°5000å…¬é‡Œ..."}] },
  shop: { name: "ç¶²æ‹å®¢æœ", color: "#d32f2f", icon: "ğŸ›ï¸", welcome: "æ‚¨å¥½ï¼é—œæ–¼è¨‚å–®æˆ–é€€æ›è²¨ï¼Ÿ", faqs: [{q:"è¨‚å–®æŸ¥è©¢",a:"è«‹æä¾›ç·¨è™Ÿ..."}] },
  clinic: { name: "è¨ºæ‰€æ›è™Ÿ", color: "#009688", icon: "ğŸ¥", welcome: "æ—©å®‰ï¼Œéœ€è¦æ›è™Ÿå—ï¼Ÿ", faqs: [{q:"é–€è¨ºæ™‚é–“",a:"æ—©è¨º9-12..."}] },
  plumbing: { name: "æ°´é›»ç¶­ä¿®", color: "#1976d2", icon: "ğŸ”§", welcome: "æ°´ç®¡æ¼æ°´ï¼Ÿé¦¬ä¸Šéå»ï¼", faqs: [{q:"é¦¬æ¡¶ä¸é€š",a:"æˆ‘å€‘å¯ä»¥ç–é€š..."}] },
  tutor: { name: "è£œç¿’ç­", color: "#673ab7", icon: "ğŸ“š", welcome: "æƒ³äº†è§£èª²ç¨‹å—ï¼Ÿ", faqs: [{q:"èª²ç¨‹è©¦è½",a:"æ­¡è¿é ç´„..."}] }
};

let currentKey = "pc_repair";

async function init() {
  // ç„¡ ID -> æ¼”ç¤ºæ¨¡å¼
  if (!CLIENT_ID) {
    document.getElementById("statusText").innerHTML = "ğŸ”´ æ¼”ç¤ºæ¨¡å¼ (ç¶²å€ç„¡ ID)";
    manualSwitch();
    return;
  }

  try {
    const res = await fetch(`${API_URL}?action=check_auth&client_id=${CLIENT_ID}`);
    const data = await res.json();

    if (data.status === 'error') return alert("ç„¡æ•ˆçš„ ID");
    
    // ğŸ”’ è‡ªå‹•é–å®šæ©Ÿåˆ¶
    if (data.status === 'expired') {
      document.getElementById("statusText").innerHTML = "ğŸ”´ å¸³è™Ÿå·²éæœŸ";
      document.getElementById("floatBtn").style.display = "none"; // éš±è—æŒ‰éˆ•
      alert("âš ï¸ è©¦ç”¨æœŸå·²éï¼Œè«‹çºŒè²»ä»¥ç¹¼çºŒä½¿ç”¨æœå‹™ã€‚");
      return;
    }

    // é©—è­‰æˆåŠŸï¼šåˆ‡æ›ä»‹é¢
    document.getElementById("adminPanel").style.display = "none";
    document.getElementById("welcomePanel").style.display = "block";
    document.getElementById("statusText").innerHTML = "ğŸŸ¢ å·²é€£ç·š";

    // ğŸŸ¢ è™•ç†è¯çµ¡è³‡è¨Š (é›»è©±/LINE)
    const contactBar = document.getElementById("contactBar");
    const btnPhone = document.getElementById("btnPhone");
    const btnLine = document.getElementById("btnLine");
    let hasContact = false;

    if (data.phone) {
      btnPhone.href = `tel:${data.phone}`;
      btnPhone.style.display = "flex";
      hasContact = true;
    } else {
      btnPhone.style.display = "none";
    }

    if (data.line) {
      btnLine.href = data.line;
      btnLine.style.display = "flex";
      hasContact = true;
    } else {
      btnLine.style.display = "none";
    }
    contactBar.style.display = hasContact ? "flex" : "none";

    // è¼‰å…¥ QA
    if (data.custom_qa && data.industry && industries[data.industry]) {
       industries[data.industry].faqs = data.custom_qa;
    }

    // åˆ‡æ›è¡Œæ¥­ & åº—å
    if (data.industry && industries[data.industry]) {
      currentKey = data.industry;
      const industryData = industries[currentKey];
      
      // å„ªå…ˆä½¿ç”¨è‡ªè¨‚åº—å
      let displayTitle = data.shop_name || industryData.name;
      
      document.getElementById("welcomeTitle").innerText = `ğŸ‘‹ æ­¡è¿ä½¿ç”¨ ${displayTitle}`;
      industries[currentKey].name = displayTitle; 
      
      updateChatUI();
    }

  } catch (e) {
    console.error(e);
  }
}

function manualSwitch() {
  currentKey = document.getElementById("industrySelect").value;
  updateChatUI();
}

function updateChatUI() {
  const data = industries[currentKey];
  document.documentElement.style.setProperty('--primary-color', data.color);
  document.getElementById("botTitle").innerText = `${data.icon} ${data.name}`;
  document.title = data.name;
  
  document.getElementById("chatBody").innerHTML = `
    <div class="message bot">
      <div class="bubble">${data.welcome}</div>
    </div>
  `;
  
  const menu = document.getElementById("quickMenu");
  menu.innerHTML = "";
  data.faqs.forEach(item => {
    const btn = document.createElement("button");
    btn.className = "menu-btn";
    btn.innerText = item.q;
    btn.onclick = () => {
      addMsg("user", item.q);
      setTimeout(() => addMsg("bot", item.a), 500);
    };
    menu.appendChild(btn);
  });
}

function toggleChat() {
  const win = document.getElementById("chatWindow");
  win.style.display = win.style.display === "flex" ? "none" : "flex";
}

function sendMessage() {
  const input = document.getElementById("userInput");
  if(!input.value) return;
  addMsg("user", input.value);
  
  let ans = "å»ºè­°æ‚¨ç›´æ¥è¯ç¹«å°ˆäººã€‚";
  const data = industries[currentKey];
  for(let f of data.faqs) {
    if(input.value.includes(f.q)) ans = f.a;
  }
  
  setTimeout(() => addMsg("bot", ans), 500);
  input.value = "";
}

function addMsg(role, text) {
  const div = document.createElement("div");
  div.className = `message ${role}`;
  div.innerHTML = `<div class="bubble">${text}</div>`;
  const body = document.getElementById("chatBody");
  body.appendChild(div);
  body.scrollTop = body.scrollHeight;
  
  if (CLIENT_ID) {
    fetch(API_URL, {
      method: 'POST', mode: 'no-cors',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ action: 'log_chat', client_id: CLIENT_ID, type: role, message: text })
    });
  }
}

document.getElementById("userInput").addEventListener("keypress", (e) => {
  if(e.key==="Enter") sendMessage();
});

init();
</script>
</body>
</html>